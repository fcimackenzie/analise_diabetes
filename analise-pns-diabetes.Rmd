---
title: "Análise, PNS - DIABETES"
subtitle: "Data Prep"
author: "Diego Aguirre, Gabriel Rodrigues, Henrique Alves"
date: "2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(srvyr)               
library(ggplot2)
library(ggpubr)
library(dplyr)
library(knitr)
library(tidyr)
```

# Introdução

## R Markdown

## Leitura e preparação dos dados

Os dados da Pesquisa Nacional de Saúde 2013 são disponibilizados pelo IBGE no seu site. 

**É importante lembrar que os dados relacionados a diabetes consideram pessoas com 18 anos ou mais**; por isso, o total de pessoas não é exatamente a população brasileira, isto é, perto de 200 milhões. mas é aproximadamente 143 milhões, com os dados de 2013.

```{r message=FALSE, warning=FALSE, echo = FALSE}

#ajustar como os resutados serão mostrados
options( survey.lonely.psu = "adjust" )

library(survey)

#importando a biblioteca.
pns_design <- readRDS(file.path(path.expand( ".." ) ,
                                "databases",
                                "2013 long questionnaire survey design.rds" ))

```


### Variáveis interessantes para análise

Variáveis Demográficas e Pessoais:

* `c006` - Sexo:
    + `1` - masculino
    + `2` - feminino
* `i001` - Tem plano de saúde
    + `1` - sim
    + `2` - não
* `c008` - Idade (numérica)
* `c009` - Cor ou Raça
   + `1` - Branca
   + `2` - Preta
   + `3` - Amarela
   + `4` - Parda
   + `5` - Indígena
   + `9` - Ignorado
* `m016` - nos últimos 12 meses, frequência de atividades esportivas
    + `1` - mais de uma vez por semana;
    + `2` - uma vez por semana;
    + `3` - de 2 a 3 vezes por mês;
    + `4` - algumas vezes no ano;
    + `5` - uma vez no ano;
    + `6` - nenhuma vez.
* `p035`  - quantos dias por semana costuma praticar exerc físico ou esporte
* `w00103` - peso final (medido) (kg)
* `w00203` - altura final (medido) (cm)
* `w00303` - circunferência cintura final (cm)

Variáveis de Utilização de Serviços de Saúde:

* `j004` - Qual foi o principal motivo de saúde que impediu _____ de realizar suas atividade habituais nas duas últimas semanas? 
   + `14` - Pressão Alta
   + `15` - Diabetes

Estilos de Vida

* `p020`	- Em quantos dias da semana o(a) Sr(a) costuma tomar refrigerante (ou suco artificial)? (0 = Nunca ou menos de uma vez por semana)
* `p021` - Que tipo de refrigerante ou suco artificial o(a) Sr(a) costuma tomar?
   + `1` - 1 copo
   + `2` - 2 copos
   + `3` - 3 copos
            Não aplicavel
* `p022`	- Em geral, quantos copos de refrigerante ou suco artificial o(a) Sr(a) costuma tomar por dia?
   + `1` - 1 copo
   + `2` - 2 copos
   + `3` - 3 copos
            Não aplicavel
* `p025`	- Em quantos dias da semana o(a) Sr(a) come alimentos doces, tais como pedaços de bolo ou torta, doces, chocolates, balas, biscoitos ou bolachas doces? (0 = Nunca ou menos de uma vez por semana)
* `p027` - Com que frequência o(a) Sr(a) costuma consumir alguma bebida alcoólica?
   + `1` - Não bebo nunca
   + `2` - Mênos de uma vez por mês
   + `3` - Uma vez ou mais por mês
            Não aplicavel
* `P028`	- Quantos dias por semana o(a) Sr(a) costuma tomar alguma bebida alcoólica? (0 = Nunca ou menos de uma vez por semana)

* `P029`	- Em geral, no dia que o(a) Sr(a) bebe, quantas doses de bebida alcoólica o(a) Sr(a) consome? (1 dose de bebida alcoólica equivale a 1 lata de cerveja, 1 taça de vinho ou 1 dose de cachaça, whisky ou qualquer outra bebida alcoólica destilada)
* `P03701`	- Em geral, no dia que o(a) Sr(a) pratica exercício ou esporte, quantas horas dura esta atividade?
* `P03702`	- Em geral, no dia que o(a) Sr(a) pratica exercício ou esporte, quantos minutos dura esta atividade?

Variáveis de Doenças Crônicas

* `Q002`	- Algum médico já lhe deu o diagnóstico de hipertensão arterial (pressão alta)?
   + `1` - Sim
   + `2` - Apenas durante a gravidez
   + `3` - Não
            Não aplicavel
* `Q029`	- 
   + `1` - Há menos de 6 meses
   + `2` - Entre 6 meses  e menos de 1 ano
   + `3` - Entre 1 ano e menos de 2 anos
   + `4` - Entre 2 anos e menos de 3 anos
   + `5` - Há 3 anos ou mais
   + `6` - Nunca fez
            Não aplicavel
* `Q030`	- Algum médico já lhe deu o diagnóstico de diabetes?
   + `1` - Sim
   + `2` - Apenas durante a gravidez (só para mulheres)
   + `3` - Não
   + `0` -  Não aplicavel
* `Q060`	- Algum médico já lhe deu o diagnóstico de colesterol alto?
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `Q068`	- Algum médico já lhe deu o diagnóstico de AVC (Acidente Vascular cerebral) ou derrame?
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `Q124`	- Algum médico já lhe deu o diagnóstico de insuficiência renal crônica?
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `S020`	- Durante o pré-natal, a Sra fez exame de sangue? 
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `S021`	- Em alguma consulta do pré-natal o médico ou enfermeiro falou que seu exame de sangue mostrou açúcar alto (presença de diabetes)?
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `W00407`	- Pressão arterial sistólica  - Final (em mmHg) 
   + `60 a 290` - mmHg
   + `999` - Erro
W00408 - Pressão arterial diastólica - Final (em mmHg) 
   + `60 a 290` - mmHg
   + `999` - Erro

Variáveis de Identificação e controle

V0001 - Unidade da Federação
V0026	- Tipo de situação censitária



```{r message=FALSE, warning=FALSE}
#Utilizando o pacote `srvyr`
library(srvyr)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(knitr)
library(tidyr)
```

```{r  echo = FALSE}
#adiciona a sintaxe dplyr de manipulação de dados ao pacote survey
pns_design_srvyr <- as_survey_design(pns_design)
```

## Criação de variáveis adicionais


### IMC -- Índice de Massa Corporal

Ao invés de utilizarmos diretamente o peso como uma variável de comparação, vamos utilizar o Índice de Massa Corporal (IMC), definido como: 

```{r  echo = FALSE}
pns_design_srvyr <- pns_design_srvyr %>% mutate(imc = w00103/(w00203/100*w00203/100)) 

```

```{r echo=FALSE }
pns_design_srvyr <- pns_design_srvyr %>% 
     mutate(imcclass = case_when(imc < 17.0 ~ "1",
                                 imc >= 17.0 & imc < 18.5 ~ "2",
                                 imc >= 18.5 & imc < 25.0 ~ "3",
                                 imc >= 25.0 & imc < 30.0 ~ "4",
                                 imc >= 30.0 & imc < 35.0 ~ "5",
                                 imc >= 35.0 & imc < 40.0 ~ "6",
                                 imc >= 40.0 ~ "7"
                                 ))

```



```{r echo=FALSE}
# Criando uma variavel idade numerica
pns_design_srvyr <- pns_design_srvyr %>% mutate(idade = as.numeric(c008))
pns_design_srvyr <- pns_design_srvyr %>% 
     mutate(fxetaria = case_when(idade <   5.0 ~ "2",
                                 idade >=  5.0 & idade < 10.0 ~ "7",
                                 idade >= 10.0 & idade < 15.0 ~ "12",
                                 idade >= 15.0 & idade < 20.0 ~ "18",
                                 idade >= 20.0 & idade < 25.0 ~ "22",
                                 idade >= 25.0 & idade < 40.0 ~ "32",
                                 idade >= 40.0 & idade < 60.0 ~ "50",
                                 idade >= 60.0 ~ "60"))
      
```

## Distribuição de pessoas por região

```{r echo=FALSE}
tir <- svytable(~ fxetaria + region, pns_design_srvyr)
tir.df <- as.data.frame(tir)
tir.spread <- spread(tir.df, region, Freq  )
kable(tir.spread, digits = 3, col.names = c("Faixa Etaria", "Norte","Nordeste","Sudeste","Sul","Centro-Oeste"), caption = "Distribuição da População por Classe de IMC por Regiões do Brasil")
```
```{r echo=FALSE}
g <- ggplot(data = tir.df) + geom_bar(aes(x = region, y = Freq/1000, fill = fxetaria), stat = "identity",  position = "dodge") + labs(x = "Região",y = "Pessoas (x1000)", title = "Distribuição da População por Faixa Etaria por Regiões do Brasil", fill = "Faixa Etaria") +  labs_pubr() + theme_pubr()
g
```


                                
### Frequência de Atividade Física

Para permitir uma melhor análise do impacto da atividade física nas doenças crônicas, criamos uma nova variável que permita relacionar a frequência de modo direto, já que a variável original `m016` apresenta uma codificação não invertida.


Valor Original    |      Codificação Original         | Novo Valor    | Codificação Variável `freqativ`
------------------|-----------------------------------|---------------|----------------------------------------
 1       |  mais de uma vez por semana       |     5      |  mais de uma vez por semana
 2       |  uma vez por semana               |     4      |  uma vez por semana
 3       |  de 2 a 3 vezes por mês           |     3      |  de 2 a 3 vezes por mês
 4       |  algumas vezes no ano             |     2      |  algumas vezes no ano
 5       |  uma vez no ano                   |     1      |    uma vez no ano
 6       |   nenhuma vez                     |     0      |     nenhuma vez

```{r echo=FALSE }

pns_design_srvyr <- pns_design_srvyr %>% mutate(freqativ = case_when(m016 == 6 ~ 0, # Nenhuma vez
                                                                     m016 == 5 ~ 1, # Uma vez/ano
                                                                     m016 == 4 ~ 2, # Algumas vezes/ano
                                                                     m016 == 3 ~ 3, # 2-3 vezes/mes
                                                                     m016 == 2 ~ 4, # Uma vez/semana
                                                                     m016 == 1 ~ 5, # Mais de uma vez/semana
                                                                     ))


```

#Frequencia de atividade fisica por idade
```{r echo=FALSE}
tff <- svytable(~ freqativ + fxetaria, pns_design_srvyr)
tff.df <- as.data.frame(tff)
tff.spread <- spread(tff.df, fxetaria, Freq  )

g <- ggplot(data = tff.df) + geom_bar(aes(x = fxetaria, y = Freq/1000, fill = freqativ), stat = "identity",  position = "dodge") + labs(x = "Faixa Etaria",y = "Pessoas (x1000)", title = "Distribuição da População por Frequencia de Ativ Fisica por Faixa Etaria", fill = "Freq Ativ Fisica") +  labs_pubr() + theme_pubr()
g

```

## Tabulações dos Dados

### Verificação de consistência das análises

```{r results= 'hide',  echo=FALSE}
tabela.prop <- prop.table(svytable(~ imcclass + region, pns_design_srvyr))
obesos.perc <- as_tibble(tabela.prop) %>% filter(imcclass >= 4) %>% summarise(tot = sum(n))
```

Para fins de consistência, buscou-se notícias sobre a obesidade no Brasil com base na Pesquisa Nacional de Saúde 2013 e foram encontradas algumas informações.

Por exemplo, o G1 da Globo colocou esta notícia na seção **Bem Estar**, em 21 de Agosto de 2015:

> **56,9% dos brasileiros têm excesso de peso, diz pesquisa de saúde do IBGE**

O link para a reportagem é:

`http://g1.globo.com/bemestar/noticia/2015/08/569-dos-brasileiros-tem-excesso-de-peso-diz-pesquisa-de-saude-do-ibge.html`

**Utilizando os dados originais da PNS, isto é, os dados baixados do IBGE e preparados para esta análise  (microdados), este índice foi calculado como** `r round(obesos.perc*100, 2)`%, ou seja, foi possível reproduzir os resultados divulgados pelo IBGE. Neste cálculo são considerados todos que estão com IMC 4 ou mais.

Outras análises e tabulações do IBGE também foram utilizadas para comparação e verificação da consistência dos resultados obtidos, indicando que a metodologia e ferramentas utilizadas aqui estão de acordo com o que é realizado pelo próprio IBGE.

### Distribuição da População por Classe de IMC por Região do Brasil

Em termos de distribuição por Regiões do Brasil, temos os seguintes resultados:

```{r echo=FALSE}
tabela <- svytable(~ imcclass + region, pns_design_srvyr)
tb.df <- as.data.frame(tabela)
tb.spread <- spread(tb.df, region, Freq  )
kable(tb.spread, digits = 3, col.names = c("Classe IMC", "Norte","Nordeste","Sudeste","Sul","Centro-Oeste"), caption = "Distribuição da População por Classe de IMC por Regiões do Brasil")
```
```{r echo=FALSE}
#* `Q030`	- Algum médico já lhe deu o diagnóstico de diabetes?
#   + `1` - Sim
#   + `2` - Apenas durante a gravidez (só para mulheres)
#   + `3` - Não
#   + `0` -  Não aplicavel

tir <- svytable(~ q030, pns_design_srvyr)
tir.df <- as.data.frame(tir)
tir.df$q030 <- c("Não aplicável", "Diabético", "Diabetes gestacional", "Não diabético")
tir.df$Freq <- tir.df$Freq / sum(tir.df$Freq)

p <-ggplot(data=tir.df, aes(x=q030, y=Freq*100)) +
  geom_bar(stat="identity", fill="steelblue") +
  geom_text(aes(label=round(Freq*100, digits = 1)), vjust=-0.5, color="black", size=3.5)+
  theme_minimal()
p
```
```{r echo=FALSE}
#* `Q030`	- Algum médico já lhe deu o diagnóstico de diabetes?
#   + `1` - Sim
#V0001 - Unidade da Federação

diab_estados <- svytable(~ q030 + region, pns_design_srvyr)
diab_estados.df <- as.data.frame(diab_estados)

diab_estados.df$Freq <- diab_estados.df$Freq / sum(diab_estados.df$Freq)



```

```{r echo=FALSE}
g <- ggplot(data = tb.df) + geom_bar(aes(x = region, y = Freq/1000, fill = imcclass), stat = "identity",  position = "dodge") + labs(x = "Região",y = "Pessoas (x1000)", title = "Distribuição da População por Classe de IMC por Regiões do Brasil", fill = "Classe IMC") +  labs_pubr() + theme_pubr()
g


```

```{r echo = FALSE }
tabelaimcreg.prop <- prop.table(svytable(~ imcclass + region, pns_design_srvyr))
kable(cbind(tb.spread$imcclass,addmargins(tabelaimcreg.prop*100, 2)), digits = 2, caption = "Proporção de Distribuição da População por Classe de IMC por Regiões do Brasil", col.names = c("Classe IMC", "Norte","Nordeste","Sudeste","Sul","Centro-Oeste", "Total (%)"))
```

### Faixas Etárias por Região do Brasil

Em termos de distribuição por Regiões do Brasil, temos os seguintes resultados:


```{r  echo=FALSE}
tabela.fxet <- svytable(~ fxetaria + region, pns_design_srvyr)
tbfxet.df <- as.data.frame(tabela.fxet)
tbfxet.spread <- spread(tbfxet.df, region, Freq  )
kable(tbfxet.spread, digits = 3, col.names = c("Faixa Etaria", "Norte","Nordeste","Sudeste","Sul","Centro-Oeste"),  caption = "Distribuição da População por Faixa Etária (acima de 18 anos) por Regiões do Brasil")
```

```{r  echo=FALSE}
g <- ggplot(data = tbfxet.df) + geom_bar(aes(x = region, y = Freq/1000, fill = fxetaria), stat = "identity",  position = "dodge") + labs(x = NULL,y = "Pessoas (x1000)", title = "Distribuição da População por Faixa Etária (acima de 18 anos) \npor Regiões do Brasil", fill = "Faixa Etária") +  labs_pubr() + theme_pubr() #+ theme(legend.position = "right")
g
```