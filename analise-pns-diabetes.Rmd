---
title: "Análise, PNS - DIABETES"
subtitle: "Data Prep"
author: "Diego Aguirre, Gabriel Rodrigues, Henrique Alves"
date: "2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(srvyr)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(knitr)
library(tidyr)
```

# Introdução

## R Markdown

## Leitura e preparação dos dados

Os dados da Pesquisa Nacional de Saúde 2013 são disponibilizados pelo IBGE no seu site. 

**É importante lembrar que os dados relacionados a diabetes consideram pessoas com 18 anos ou mais**; por isso, o total de pessoas não é exatamente a população brasileira, isto é, perto de 200 milhões. mas é aproximadamente 143 milhões, com os dados de 2013.

```{r message=FALSE, warning=FALSE, echo = FALSE}

#ajustar como os resutados serão mostrados
options( survey.lonely.psu = "adjust" )

library(survey)

#importando a biblioteca.
pns_design <- readRDS(file.path(path.expand( ".." ) ,
                                "databases",
                                "2013 long questionnaire survey design.rds" ))

```


### Variáveis interessantes para análise

Variáveis Demográficas e Pessoais:

* `c006` - Sexo:
    + `1` - masculino
    + `2` - feminino
* `i001` - Tem plano de saúde
    + `1` - sim
    + `2` - não
* `c008` - Idade (numérica)
* `c009` - Cor ou Raça
   + `1` - Branca
   + `2` - Preta
   + `3` - Amarela
   + `4` - Parda
   + `5` - Indígena
   + `9` - Ignorado
* `m016` - nos últimos 12 meses, frequência de atividades esportivas
    + `1` - mais de uma vez por semana;
    + `2` - uma vez por semana;
    + `3` - de 2 a 3 vezes por mês;
    + `4` - algumas vezes no ano;
    + `5` - uma vez no ano;
    + `6` - nenhuma vez.
* `p035`  - quantos dias por semana costuma praticar exerc físico ou esporte
* `w00103` - peso final (medido) (kg)
* `w00203` - altura final (medido) (cm)
* `w00303` - circunferência cintura final (cm)

Variáveis de Utilização de Serviços de Saúde:

* `j004` - Qual foi o principal motivo de saúde que impediu _____ de realizar suas atividade habituais nas duas últimas semanas? 
   + `14` - Pressão Alta
   + `15` - Diabetes

Estilos de Vida

* `p020`	- Em quantos dias da semana o(a) Sr(a) costuma tomar refrigerante (ou suco artificial)? (0 = Nunca ou menos de uma vez por semana)
* `p021` - Que tipo de refrigerante ou suco artificial o(a) Sr(a) costuma tomar?
   + `1` - 1 copo
   + `2` - 2 copos
   + `3` - 3 copos
            Não aplicavel
* `p022`	- Em geral, quantos copos de refrigerante ou suco artificial o(a) Sr(a) costuma tomar por dia?
   + `1` - 1 copo
   + `2` - 2 copos
   + `3` - 3 copos
            Não aplicavel
* `p025`	- Em quantos dias da semana o(a) Sr(a) come alimentos doces, tais como pedaços de bolo ou torta, doces, chocolates, balas, biscoitos ou bolachas doces? (0 = Nunca ou menos de uma vez por semana)
* `p027` - Com que frequência o(a) Sr(a) costuma consumir alguma bebida alcoólica?
   + `1` - Não bebo nunca
   + `2` - Mênos de uma vez por mês
   + `3` - Uma vez ou mais por mês
            Não aplicavel
* `P028`	- Quantos dias por semana o(a) Sr(a) costuma tomar alguma bebida alcoólica? (0 = Nunca ou menos de uma vez por semana)

* `P029`	- Em geral, no dia que o(a) Sr(a) bebe, quantas doses de bebida alcoólica o(a) Sr(a) consome? (1 dose de bebida alcoólica equivale a 1 lata de cerveja, 1 taça de vinho ou 1 dose de cachaça, whisky ou qualquer outra bebida alcoólica destilada)
* `P03701`	- Em geral, no dia que o(a) Sr(a) pratica exercício ou esporte, quantas horas dura esta atividade?
* `P03702`	- Em geral, no dia que o(a) Sr(a) pratica exercício ou esporte, quantos minutos dura esta atividade?

Variáveis de Doenças Crônicas

* `Q002`	- Algum médico já lhe deu o diagnóstico de hipertensão arterial (pressão alta)?
   + `1` - Sim
   + `2` - Apenas durante a gravidez
   + `3` - Não
            Não aplicavel
* `Q029`	- 
   + `1` - Há menos de 6 meses
   + `2` - Entre 6 meses  e menos de 1 ano
   + `3` - Entre 1 ano e menos de 2 anos
   + `4` - Entre 2 anos e menos de 3 anos
   + `5` - Há 3 anos ou mais
   + `6` - Nunca fez
            Não aplicavel
* `Q030`	- Algum médico já lhe deu o diagnóstico de diabetes?
   + `1` - Sim
   + `2` - Apenas durante a gravidez (só para mulheres)
   + `3` - Não
            Não aplicavel
* `Q060`	- Algum médico já lhe deu o diagnóstico de colesterol alto?
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `Q068`	- Algum médico já lhe deu o diagnóstico de AVC (Acidente Vascular cerebral) ou derrame?
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `Q124`	- Algum médico já lhe deu o diagnóstico de insuficiência renal crônica?
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `S020`	- Durante o pré-natal, a Sra fez exame de sangue? 
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `S021`	- Em alguma consulta do pré-natal o médico ou enfermeiro falou que seu exame de sangue mostrou açúcar alto (presença de diabetes)?
   + `1` - Sim
   + `2` - Não
            Não aplicavel
* `W00407`	- Pressão arterial sistólica  - Final (em mmHg) 
   + `60 a 290` - mmHg
   + `999` - Erro
W00408 - Pressão arterial diastólica - Final (em mmHg) 
   + `60 a 290` - mmHg
   + `999` - Erro

Variáveis de Identificação e controle

V0001 - Unidade da Federação
V0026	- Tipo de situação censitária



```{r message=FALSE, warning=FALSE}
#Utilizando o pacote `srvyr`
library(srvyr)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(knitr)
library(tidyr)
```

```{r  echo = FALSE}
#adiciona a sintaxe dplyr de manipulação de dados ao pacote survey
pns_design_srvyr <- as_survey_design(pns_design)
```

## Criação de variáveis adicionais


### IMC -- Índice de Massa Corporal

Ao invés de utilizarmos diretamente o peso como uma variável de comparação, vamos utilizar o Índice de Massa Corporal (IMC), definido como: 

$$\mbox{IMC} = \frac{\mbox{peso}}{\mbox{altura}^2}$$

```{r  echo = FALSE}
pns_design_srvyr <- pns_design_srvyr %>% mutate(imc = w00103/(w00203/100*w00203/100)) 
```

Vamos considerar também as faixas do IMC definidas pela Organização Mundial da Saúde, conforme mostrado na tabela a seguir:

Classificação        |  Faixa de Peso    |       Sintomas
---------------------|-------------------|----------------------------------------------------
Muito abaixo do peso |16 a 16,9 kg/m2    | Queda de cabelo, infertilidade, ausência menstrual
Abaixo do peso       |17 a 18,4 kg/m2    | Fadiga, stress, ansiedade
Peso normal          |18,5 a 24,9 kg/m2  | Menor risco de doenças cardíacas e vasculares
Acima do peso        |25 a 29,9 kg/m2    | Fadiga, má circulação, varizes
Obesidade Grau I     |30 a 34,9 kg/m2    | Diabetes, angina, infarto, aterosclerose
Obesidade Grau II    |35 a 40 kg/m2      | Apneia do sono, falta de ar
Obesidade Grau III   |maior que 40 kg/m2 | Refluxo, dificuldade para se mover, escaras, diabetes, infarto, AVC

```{r echo=FALSE }
pns_design_srvyr <- pns_design_srvyr %>% 
     mutate(imcclass = case_when(imc < 17.0 ~ "1",
                                 imc >= 17.0 & imc < 18.5 ~ "2",
                                 imc >= 18.5 & imc < 25.0 ~ "3",
                                 imc >= 25.0 & imc < 30.0 ~ "4",
                                 imc >= 30.0 & imc < 35.0 ~ "5",
                                 imc >= 35.0 & imc < 40.0 ~ "6",
                                 imc >= 40.0 ~ "7"
                                 ))

```



```{r echo=FALSE}
# Criando uma variavel de faixa etaria
pns_design_srvyr <- pns_design_srvyr %>% mutate(idade = as.numeric(c008))
pns_design_srvyr <- pns_design_srvyr %>% 
     mutate(fxetaria = case_when(idade <   5.0 ~ "2",
                                 idade >=  5.0 & idade < 10.0 ~ "7",
                                 idade >= 10.0 & idade < 15.0 ~ "12",
                                 idade >= 15.0 & idade < 20.0 ~ "18",
                                 idade >= 20.0 & idade < 25.0 ~ "22",
                                 idade >= 25.0 & idade < 40.0 ~ "32",
                                 idade >= 40.0 & idade < 60.0 ~ "50",
                                 idade >= 60.0 ~ "60"))
      
```




## Prevalência de pessoas com diabetes

Para verificarmos se nossas métricas estão corretas buscamos referência sobre a análise de diabetes pela PNS através de outras fontes:

Artigo:
   http://www.scielo.br/scielo.php?pid=s2237-96222015000200305&script=sci_abstract&tlng=pt
   
Fiocruz:
   https://portal.fiocruz.br/noticia/diabetes-pesquisa-avalia-os-fatores-associados-qualidade-de-vida

Os dados das duas fontes mostram que a porcentagem de diabéticos foi de 6.2%, correspondendo com o nosso gráfico abaixo. 

```{r echo=FALSE}
# q030 variável se diagnostico de diabetes
tir <- svytable(~ q030, pns_design_srvyr)
tir.df <- as.data.frame(tir)
tir.df$q030 <- c("Não Aplicável", "Diabético", "Diabete Gestacional", "Não Diabético")
tir.df$Freq <- tir.df$Freq / sum(tir.df$Freq) 

p <-ggplot(data=tir.df, aes(x=q030, y=Freq*100, fill = q030)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(Freq*100, digits = 1)), vjust=-0.5, color="black", size=3.5)+ 
  labs_pubr() + theme_pubr()
p

```

## Porcentagem de Diagnóstico de Diabetes por sexo
```{r echo=FALSE}
# c006 variavel do sexo do individuo

diab_sexo <- survey::svytable(~ q030 + c006, pns_design_srvyr)
diab_sexo.df <- as.data.frame(diab_sexo)


diab_sexo.df[diab_sexo.df$c006 == "masculino",c("Freq")] <- diab_sexo.df[diab_sexo.df$c006 == "masculino",c("Freq")]/sum(diab_sexo.df[diab_sexo.df$c006 == "masculino",c("Freq")] )
                                                                                                         diab_sexo.df[diab_sexo.df$c006 == "feminino",c("Freq")] <- diab_sexo.df[diab_sexo.df$c006 == "feminino",c("Freq")]/sum(diab_sexo.df[diab_sexo.df$c006 == "feminino",c("Freq")] )                                 
                                                                                       
diab_sexo.df$q030 <-  c("Não Aplicável", "Diabético", "Diabete Gestacional", "Não Diabético", "Não Aplicável", "Diabético", "Diabete Gestacional", "Não Diabético")

                                                                                                         
p1 <-ggplot(data=diab_sexo.df, aes(x=q030, y=Freq*100 ,fill=c006)) +
  geom_bar(position="dodge", stat="identity") +
  geom_text(aes(label=round(Freq*100, digits = 1)), position=position_dodge(width=0.9), vjust=-0.5, color="black", size=3.5)+
  theme_minimal()+
  ggtitle("Porcentagem diabetes por sexo") +
  xlab("Categoria") + ylab("Porcentagem %") 


p1

```


## Procentagem de diabéticos por Faixa Etária
```{r echo=FALSE}

fxetaria_diab.df = as.data.frame(svytable(~fxetaria + q030, pns_design_srvyr))

grp <- group_by(fxetaria_diab.df, fxetaria) %>% summarise(freq = sum(Freq))

fxetaria_diab.df <- fxetaria_diab.df[fxetaria_diab.df$q030 == "1",]

fxetaria_diab.df$Freq <- fxetaria_diab.df$Freq/grp$freq

fxetaria_diab.df <- fxetaria_diab.df[-2]

p <- ggplot(data=fxetaria_diab.df, aes(x=fxetaria, y=Freq * 100, fill = fxetaria)) +     
   geom_bar( stat = "identity",  position = "dodge")+  geom_text(aes(label=round(Freq*100, digits = 1)), position=position_dodge(width=0.9), vjust=-0.5, color="black", size=3.5)

p

```


                                
### Frequência de Atividade Física

Para permitir uma melhor análise do impacto da atividade física nas doenças crônicas, criamos uma nova variável que permita relacionar a frequência de modo direto, já que a variável original `m016` apresenta uma codificação não invertida.


Valor Original    |      Codificação Original         | Novo Valor    | Codificação Variável `freqativ`
------------------|-----------------------------------|---------------|----------------------------------------
 1                |  mais de uma vez por semana       |     5      |  mais de uma vez por semana
 2                |  uma vez por semana               |     4      |  uma vez por semana
 3                |  de 2 a 3 vezes por mês           |     3      |  de 2 a 3 vezes por mês
 4                |  algumas vezes no ano             |     2      |  algumas vezes no ano
 5                |  uma vez no ano                   |     1      |    uma vez no ano
 6                |   nenhuma vez                     |     0      |     nenhuma vez

```{r echo=FALSE }

pns_design_srvyr <- pns_design_srvyr %>% mutate(freqativ = case_when(m016 == 6 ~ 0, # Nenhuma vez
                                                                     m016 == 5 ~ 1, # Uma vez/ano
                                                                     m016 == 4 ~ 2, # Algumas vezes/ano
                                                                     m016 == 3 ~ 3, # 2-3 vezes/mes
                                                                     m016 == 2 ~ 4, # Uma vez/semana
                                                                     m016 == 1 ~ 5, # Mais de uma vez/semana
                                                                     ))


```

##Frequencia de diabetes por frequencia de atividade física
```{r echo=FALSE}
freq_diab <- svytable(~ q030 + freqativ , pns_design_srvyr)
freq_diab.df <- as.data.frame(freq_diab)

freq_diab.df <- freq_diab.df[freq_diab.df$q030 == '1',]

freq_diab.df$Freq <- freq_diab.df$Freq/sum(freq_diab.df$Freq)    

g <- ggplot(data = freq_diab.df) + 
   geom_bar(aes(x = freqativ, y = Freq, fill=freqativ ), stat = "identity",  position = "dodge") +
   labs(x = "Freq Ativ Fisica",y = "Pessoas %", title = "Frequencia de Ativ Fisica por Faixa Diabetes") 
g

```


## Taxa de diabéticos por região e por situação censitária

```{r echo=FALSE}
#* `Q030`	- Algum médico já lhe deu o diagnóstico de diabetes?
#   + `1` - Sim
#region
diab_estados <- svytable(~ q030 + region + v0026, pns_design_srvyr )
diab_estados.df <- as.data.frame(diab_estados)
diab_estados.df <- diab_estados.df[diab_estados.df$q030 == '1',]
diab_estados.df$Freq <- diab_estados.df$Freq / sum(diab_estados.df$Freq)

diab_estados.df$v0026 = as.character(diab_estados.df$v0026)
diab_estados.df$v0026[diab_estados.df$v0026 == 1]  = "1 - Urbano"
diab_estados.df$v0026[diab_estados.df$v0026 == 2]  = "2 - Rural"

p <-ggplot(data=diab_estados.df, aes(x=region, y=Freq*100, fill=v0026)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(Freq*100, digits = 1)), vjust=1, color="black", size=3.5)
p
```

## Distribuição das taxas de diabéticos por estado
```{r echo=FALSE}
#* `Q030`	- Algum médico já lhe deu o diagnóstico de diabetes?
#   + `1` - Sim
#   + V0001 - Unidade da Federação
library(brazilmaps)
mapa <- get_brmap("State")
diab_estados <- svytable(~ v0001 + q030 , pns_design_srvyr)
diab_estados.df <- as.data.frame(diab_estados)
diab_estados.df <- diab_estados.df[diab_estados.df$q030 == '1',]
diab_estados.df$Freq <- (diab_estados.df$Freq / sum(diab_estados.df$Freq))
teste <- toupper(c("Rondônia","Acre","Amazonas","Roraima","Pará","Amapá","Tocantins","Maranhão","Piauí","Ceará",
          "Rio Grande do Norte","Paraíba","Pernambuco","Alagoas","Sergipe","Bahia","Minas Gerais","Espírito Santo","Rio de Janeiro","São Paulo","Paraná","Santa Catarina","Rio Grande do Sul","Mato Grosso do Sul",
          "Mato Grosso","Goiás","Distrito Federal"))

teste <- as.data.frame(teste)
teste$Freq <- diab_estados.df$Freq
uf_map <- get_brmap("State") %>% 
  inner_join(teste, c("nome" = "teste"))
uf_map %>% 
  ggplot() +
  geom_sf(aes(fill = Freq))+
  scale_fill_continuous(low = "lightblue", high = "darkblue") 
 
#estados<-readOGR("data/estados_br", "UFEBRASIL", encoding = "utf8")
#diab_estados <- svytable(~ v0001 + q030 , pns_design_srvyr)
#diab_estados.df <- as.data.frame(diab_estados)
#diab_estados.df <- diab_estados.df[diab_estados.df$q030 == '1',]
#diab_estados.df$Freq <- diab_estados.df$Freq / sum(diab_estados.df$Freq)
```